#include <stdio.h>
#include <math.h>
#include <time.h>
#include <stdlib.h>

#define EPS 1.0e-16
#define NMAX 16384
#define N8 8
#define N32 32
#define N64 64
#define CLOCK_MONOTONIC 1

// Function prototypes
double f(double x);
double gauss16(double (*f)(double), double a, double b);
double gauss32(double (*f)(double), double a, double b);
double gauss64(double (*f)(double), double a, double b);
void gauss2(double (*f)(double), double a, double b, double eps, double *integral, int *nint);

int main() {
    double a = -2.0, b = 2.0, integral;
    int nint;
    struct timespec start, stop;

    printf("Integration of a function using Gauss 32 and 64 points with doubling\n");
    printf("number of intervals till error = |I_64 - I_32| < eps.\n");

    // Get starting time
    clock_gettime(CLOCK_MONOTONIC, &start);

    gauss2(f, a, b, EPS, &integral, &nint);
    
    // Get end time
    clock_gettime(CLOCK_MONOTONIC, &stop);
	// Calculate the elapsed time in seconds
    double elapsed_time = (stop.tv_sec - start.tv_sec) * 1e9;
    elapsed_time = (elapsed_time + (stop.tv_nsec - start.tv_nsec)) * 1e-9;

    printf("   intervals = %d\n", nint);
    printf("   integral  = %.16e\n", integral);
    printf("Calculation time is %.3e seconds.\n", elapsed_time);
    
    return 0;
}

double f(double x) {
    return exp(-x * x);
}

void gauss2(double (*f)(double), double a, double b, double eps, double *integral, int *nint) {
    double s1, s2, h, ax, bx;
    int n = 1;

    printf("   i           ax                bx                s1                   s2\n");
    
    while (n <= NMAX) {
        s1 = 0.0;
        s2 = 0.0;
        h = (b - a) / (double)n;

        for (int i = 1; i <= n; i++) {
            ax = a + h * (i - 1);
            bx = ax + h;
            s1 += gauss32(f, ax, bx);
            s2 += gauss64(f, ax, bx);
        }
        
        printf("%4d %16.4e %16.4e %20.14e %20.14e\n", n, ax, bx, s1, s2);

        if (fabs(s2 - s1) <= eps && fabs(s2 - s1) / fabs(s2 + s1) <= eps) {
            *integral = s2;
            *nint = n;
            return;
        }
        *integral = s2;
        *nint = n;
        n *= 2;
    }
}

double gauss16(double (*f)(double), double a, double b) {
    double x16[N8] = {
        0.0950125098376374, 0.2816035507792589, 0.4580167776572274, 0.6178762444026438,
        0.7554044083550030, 0.8656312023878318, 0.9445750230732326, 0.9894009349916499
    };
    double w16[N8] = {
        0.1894506104550685, 0.1826034150449236, 0.1691565193950025, 0.1495959888165767,
        0.1246289712555339, 0.0951585116824928, 0.0622535239386479, 0.0271524594117541
    };
    
    double r = 0.0;
    double m = (b - a) / 2.0;
    double c = (b + a) / 2.0;

    for (int i = 0; i < N8; i++) {
        r += w16[i] * (f(m * (-1.0) * x16[i] + c) + f(m * x16[i] + c));
    }
    
    return r * m;
}

double gauss32(double (*f)(double), double a, double b) {
    double x32[N32] = {
        -0.0483076656877383, 0.0483076656877383, -0.144471961582797, 0.144471961582797,
        -0.2392873622521371, 0.2392873622521371, -0.331868602282128, 0.331868602282128,
        -0.4213512761306353, 0.4213512761306353, -0.506899908932229, 0.506899908932229,
        -0.5877157572407623, 0.5877157572407623, -0.663044266930215, 0.663044266930215,
        -0.7321821187402897, 0.7321821187402897, -0.794483795967942, 0.794483795967942,
        -0.8493676137325700, 0.8493676137325700, -0.896321155766052, 0.896321155766052,
        -0.9349060759377397, 0.9349060759377397, -0.964762255587506, 0.964762255587506,
        -0.9856115115452684, 0.9856115115452684, -0.997263861849482, 0.997263861849482
    };
    double w32[N32] = {
        0.0965400885147278, 0.0965400885147278, 0.0956387200792749, 0.0956387200792749,
        0.0938443990808046, 0.0938443990808046, 0.0911738786957639, 0.0911738786957639,
        0.0876520930044038, 0.0876520930044038, 0.0833119242269467, 0.0833119242269467,
        0.0781938957870703, 0.0781938957870703, 0.0723457941088485, 0.0723457941088485,
        0.0658222227763618, 0.0658222227763618, 0.0586840934785355, 0.0586840934785355,
        0.0509980592623762, 0.0509980592623762, 0.0428358980222267, 0.0428358980222267,
        0.0342738629130214, 0.0342738629130214, 0.0253920653092621, 0.0253920653092621,
        0.0162743947309057, 0.0162743947309057, 0.0070186100094701, 0.0070186100094701
    };
    
    double r = 0.0;
    double m = (b - a) / 2.0;
    double c = (b + a) / 2.0;

    for (int i = 0; i < N32; i++) {
        r += w32[i] * f(m * x32[i] + c);
    }

    return r * m;
}

double gauss64(double (*f)(double), double a, double b) {
    double x64[N64] = {
        -0.0243502926634244, 0.0243502926634244, -0.072993121787799, 0.072993121787799, -0.121462819296121, 0.121462819296121, -0.169644420423993, 0.169644420423993,
        -0.2174236437400070, 0.2174236437400070, -0.264687162208767, 0.264687162208767, -0.311322871990211, 0.311322871990211, -0.357220158337668, 0.357220158337668,
        -0.4022701579639920, 0.4022701579639920, -0.446366017253464, 0.446366017253464, -0.489403145707053, 0.489403145707053, -0.531279464019895, 0.531279464019895,
        -0.5718956462026340, 0.5718956462026340, -0.611155355172393, 0.611155355172393, -0.648965471254657, 0.648965471254657, -0.685236313054233, 0.685236313054233,
        -0.7198818501716110, 0.7198818501716110, -0.752819907260532, 0.752819907260532, -0.783972358943341, 0.783972358943341, -0.813265315122798, 0.813265315122798,
        -0.8406292962525800, 0.8406292962525800, -0.865999398154093, 0.865999398154093, -0.889315445995114, 0.889315445995114, -0.910522137078503, 0.910522137078503,
        -0.9295691721319400, 0.9295691721319400, -0.946411374858403, 0.946411374858403, -0.961008799652054, 0.961008799652054, -0.973326827789911, 0.973326827789911,
        -0.9833362538846260, 0.9833362538846260, -0.991013371476744, 0.991013371476744, -0.996340116771955, 0.996340116771955, -0.999305041735772, 0.999305041735772 };
    double w64[N64] = {
        0.0486909570091397, 0.0486909570091397, 0.0485754674415034, 0.0485754674415034, 0.0483447622348030, 0.0483447622348030, 0.0479993885964583, 0.0479993885964583,
        0.0475401657148303, 0.0475401657148303, 0.0469681828162100, 0.0469681828162100, 0.0462847965813144, 0.0462847965813144, 0.0454916279274181, 0.0454916279274181,
        0.0445905581637566, 0.0445905581637566, 0.0435837245293235, 0.0435837245293235, 0.0424735151236536, 0.0424735151236536, 0.0412625632426235, 0.0412625632426235,
        0.0399537411327203, 0.0399537411327203, 0.0385501531786156, 0.0385501531786156, 0.0370551285402400, 0.0370551285402400, 0.0354722132568824, 0.0354722132568824,
        0.0338051618371416, 0.0338051618371416, 0.0320579283548516, 0.0320579283548516, 0.0302346570724025, 0.0302346570724025, 0.0283396726142595, 0.0283396726142595,
        0.0263774697150547, 0.0263774697150547, 0.0243527025687109, 0.0243527025687109, 0.0222701738083833, 0.0222701738083833, 0.0201348231535302, 0.0201348231535302,
        0.0179517157756973, 0.0179517157756973, 0.0157260304760247, 0.0157260304760247, 0.0134630478967186, 0.0134630478967186, 0.0111681394601311, 0.0111681394601311,
        0.0088467598263639, 0.0088467598263639, 0.0065044579689784, 0.0065044579689784, 0.0041470332605625, 0.0041470332605625, 0.0017832807216964, 0.0017832807216964 };
    
    double r = 0.0;
    double m = (b - a) / 2.0;
    double c = (b + a) / 2.0;

    for (int i = 0; i < N64; i++) {
        r += w64[i] * f(m * x64[i] + c);
    }

    return r * m;
}


